<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>¬°Pago Exitoso! - PagosBot PRO</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .confirmation-container {
            max-width: 700px;
            margin: 120px auto 50px;
            padding: 2rem;
            text-align: center;
        }

        .success-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            animation: scaleIn 0.5s ease-out;
        }

        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }

        .success-card {
            background: white;
            padding: 3rem 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .success-card h1 {
            color: #059669;
            margin-bottom: 1rem;
            font-size: 2rem;
        }

        .success-card p {
            color: #666;
            line-height: 1.8;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        .purchase-details {
            background: #f3f4f6;
            padding: 1.5rem;
            border-radius: 12px;
            margin: 2rem 0;
            text-align: left;
        }

        .purchase-details h3 {
            color: #1e40af;
            margin-bottom: 1rem;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: #333;
        }

        .detail-value {
            color: #666;
        }

        .status-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            margin: 1rem 0;
        }

        .status-success {
            background: #d1fae5;
            color: #059669;
        }

        .status-processing {
            background: #dbeafe;
            color: #3b82f6;
        }

        .btn-home {
            display: inline-block;
            padding: 1rem 3rem;
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            margin-top: 2rem;
            transition: all 0.3s;
        }

        .btn-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(30, 64, 175, 0.3);
        }

        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .email-sent {
            background: #eff6ff;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 2rem;
            text-align: left;
        }

        .email-sent strong {
            color: #1e40af;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="logo">üí∞ PagosBot PRO</h1>
        </div>
    </nav>

    <div class="confirmation-container">
        <div class="success-card">
            <div class="success-icon">‚úÖ</div>
            <h1>¬°Pago Exitoso!</h1>
            <p>Tu compra se ha procesado correctamente</p>

            <div class="status-badge status-processing" id="webhookStatus">
                <span class="spinner"></span>
                Procesando tu pedido...
            </div>

            <div class="purchase-details" id="purchaseDetails">
                <h3>üìã Detalles de tu compra</h3>
                <div class="detail-row">
                    <span class="detail-label">Plan:</span>
                    <span class="detail-value" id="planName">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Valor:</span>
                    <span class="detail-value" id="planPrice">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Email:</span>
                    <span class="detail-value" id="customerEmail">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Referencia:</span>
                    <span class="detail-value" id="transactionId">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Fecha:</span>
                    <span class="detail-value" id="purchaseDate">-</span>
                </div>
            </div>

            <div class="email-sent" id="emailInfo" style="display: none;">
                <strong>üìß ¬°Tu archivo est√° en camino!</strong><br>
                Hemos enviado el archivo digital a tu correo electr√≥nico. 
                Si no lo ves en unos minutos, revisa tu carpeta de spam.
            </div>

            <a href="index.html" class="btn-home">üè† Volver al inicio</a>
        </div>
    </div>

    <footer style="margin-top: 5rem;">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2025 PagosBot PRO - Variedades JyM</p>
            </div>
        </div>
    </footer>

    <script>
        // Mapeo de planes
        const planData = {
            basico: { 
                name: 'Plan B√°sico', 
                price: 29900,
                file: 'PagosBot_Basico.xlsx'
            },
            premium: { 
                name: 'Plan Pro', 
                price: 49900,
                file: 'PagosBot_Pro.xlsx'
            },
            empresarial: { 
                name: 'Plan Empresarial', 
                price: 99900,
                file: 'PagosBot_Empresarial.xlsx'
            }
        };

        // Obtener par√°metros del URL
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                id: urlParams.get('id'),
                status: urlParams.get('status'),
                reference: urlParams.get('reference'),
                plan: urlParams.get('plan') || 'basico',
                customerEmail: urlParams.get('email') || '',
                customerName: urlParams.get('name') || ''
            };
        }

        // Mostrar detalles de la compra
        function displayPurchaseDetails(params) {
            const plan = planData[params.plan] || planData.basico;
            
            document.getElementById('planName').textContent = plan.name;
            document.getElementById('planPrice').textContent = '$' + plan.price.toLocaleString('es-CO') + ' COP';
            document.getElementById('customerEmail').textContent = params.customerEmail || 'No especificado';
            document.getElementById('transactionId').textContent = params.reference || params.id || 'WOMPI-' + Date.now();
            document.getElementById('purchaseDate').textContent = new Date().toLocaleDateString('es-CO', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Enviar datos al webhook de Make.com
        async function sendToWebhook(params) {
            const webhookUrl = localStorage.getItem('make_webhook_url');
            
            if (!webhookUrl) {
                console.error('No hay webhook configurado');
                updateStatus('warning', '‚ö†Ô∏è Configuraci√≥n pendiente');
                document.getElementById('emailInfo').style.display = 'block';
                return;
            }

            const plan = planData[params.plan] || planData.basico;
            
            const webhookData = {
                event: 'payment_success',
                transaction: {
                    id: params.reference || params.id || 'WOMPI-' + Date.now(),
                    status: 'APPROVED',
                    reference: params.reference || params.id,
                    date: new Date().toISOString()
                },
                customer: {
                    name: params.customerName || 'Cliente',
                    email: params.customerEmail || 'no-email@ejemplo.com'
                },
                plan: {
                    type: params.plan,
                    name: plan.name,
                    price: plan.price,
                    currency: 'COP',
                    file_to_send: plan.file
                },
                metadata: {
                    source: 'confirmacion_page',
                    timestamp: new Date().toISOString(),
                    url: window.location.href
                }
            };

            try {
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookData)
                });

                if (response.ok) {
                    updateStatus('success', '‚úÖ Pedido procesado');
                    document.getElementById('emailInfo').style.display = 'block';
                    console.log('Datos enviados exitosamente al webhook');
                } else {
                    throw new Error('Error al enviar datos');
                }
            } catch (error) {
                console.error('Error:', error);
                updateStatus('error', '‚ö†Ô∏è Error al procesar');
                document.getElementById('emailInfo').style.display = 'block';
            }
        }

        // Actualizar estado visual
        function updateStatus(type, message) {
            const statusBadge = document.getElementById('webhookStatus');
            statusBadge.innerHTML = message;
            
            if (type === 'success') {
                statusBadge.className = 'status-badge status-success';
            } else {
                statusBadge.className = 'status-badge status-processing';
            }
        }

        // Ejecutar al cargar la p√°gina
        window.addEventListener('load', function() {
            const params = getUrlParams();
            displayPurchaseDetails(params);
            
            setTimeout(() => {
                sendToWebhook(params);
            }, 1000);
        });
    </script>
</body>
</html>